version-tags: &version-tags
    tags:
        only: /\d+\.\d+\.\d+(-(alpha|beta|rc|dev|post)\d+)?/

version: 2.1
orbs:
  python: circleci/python@3.0.0
jobs:
    test-310:
        executor: python/default
        steps:
            - checkout
            - python/install-packages:
                pkg-manager: uv
            - run:
                name: "Installation"
                command: uv sync --extra dev
            - run:
                name: "Run pytest"
                command: uv run pytest --doctest-modules numpoly/ test/
            - run:
                name: "Run pydocstyle"
                command: uv run pydocstyle --ignore=D202,D203,D212 numpoly
            - run:
                name: "Run black"
                command: uv run black --check numpoly
            - run:
                name: "Run Sphinx build"
                command: uv run sphinx-build docs/ docs/.build -b html -v --color -T -W --keep-going
    deploy:
        executor: python/default
        steps:
            - checkout
            - python/install-packages:
                pkg-manager: uv
            - run:
                name: "Set tag version"
                command: sed -i 's/version = "0\.1\.0"/version = "'$CIRCLE_TAG'"/' pyproject.toml
            - run:
                name: "Installation"
                command: uv sync --extra dev
            - run:
                name: "Publish to PyPI"
                command: |
                    uv pip install twine build
                    uv run python -m build -s
                    uv run twine upload -u __token__ -p $PYPI_PASSWORD --non-interactive dist/*

workflows:
    version: 2.1
    workflow:
        jobs:
            - test-310:
                filters:
                    <<: *version-tags
            - deploy:
                requires:
                    - test-310
                filters:
                    <<: *version-tags
                    branches:
                        ignore: /.*/
